
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trend Hunter â€” 4-Month Momentum Scanner</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap');

  :root {
    --bg: #0a0c0f; --panel: #111418; --border: #1e2530;
    --accent: #00ff88; --accent2: #00c4ff; --red: #ff4466;
    --yellow: #ffcc00; --text: #e8edf5; --muted: #5a6478; --card: #141820;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg); color: var(--text);
    font-family: 'Syne', sans-serif; min-height: 100vh; overflow-x: hidden;
  }

  body::before {
    content: ''; position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.025) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.025) 1px, transparent 1px);
    background-size: 44px 44px; pointer-events: none; z-index: 0;
  }

  .wrap { position: relative; z-index: 1; max-width: 1200px; margin: 0 auto; padding: 0 24px 80px; }

  header { padding: 36px 0 28px; border-bottom: 1px solid var(--border); }
  .header-inner { display: flex; align-items: flex-end; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
  .logo-tag { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--accent); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
  h1 { font-size: clamp(26px, 4.5vw, 46px); font-weight: 800; letter-spacing: -1.5px; line-height: 1; }
  h1 em { color: var(--accent); font-style: normal; }
  .subtitle { font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); margin-top: 8px; letter-spacing: 1px; }
  .hdr-btns { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

  .btn-primary {
    background: var(--accent); color: #000; border: none; padding: 13px 28px;
    font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
    letter-spacing: 1px; text-transform: uppercase; cursor: pointer;
    clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 10px 100%, 0 calc(100% - 10px));
    transition: all 0.2s; white-space: nowrap;
  }
  .btn-primary:hover { background: #00ffaa; transform: translateY(-1px); }
  .btn-primary:disabled { background: var(--muted); cursor: not-allowed; transform: none; }

  .data-mode {
    font-family: 'Space Mono', monospace; font-size: 9px; letter-spacing: 1px;
    padding: 5px 10px; border: 1px solid var(--border); color: var(--muted);
    text-transform: uppercase;
  }
  .data-mode.live { border-color: var(--accent); color: var(--accent); }
  .data-mode.sim  { border-color: var(--yellow); color: var(--yellow); }

  .filters {
    display: flex; gap: 12px; flex-wrap: wrap; align-items: center;
    padding: 20px 0; border-bottom: 1px solid var(--border);
  }
  .filter-chip {
    display: flex; align-items: center; gap: 8px;
    background: var(--panel); border: 1px solid var(--border); padding: 7px 14px;
  }
  .filter-chip label { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; white-space: nowrap; }
  .filter-chip input[type=number], .filter-chip select {
    background: transparent; border: none; outline: none;
    color: var(--text); font-family: 'Space Mono', monospace; font-size: 12px;
    cursor: pointer; -webkit-appearance: none; width: auto;
  }
  .filter-chip select option { background: #1a1f28; }

  .statusbar {
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    padding: 14px 0; border-bottom: 1px solid var(--border);
    font-family: 'Space Mono', monospace; font-size: 10px; color: var(--muted); min-height: 50px;
  }
  .dot { width: 7px; height: 7px; border-radius: 50%; background: var(--muted); flex-shrink: 0; transition: background 0.3s; }
  .dot.run  { background: var(--accent); animation: blink 0.9s ease-in-out infinite; }
  .dot.done { background: var(--accent); }
  .dot.warn { background: var(--yellow); }
  .dot.err  { background: var(--red); }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.2} }

  .progress-track { height: 2px; background: var(--border); width: 220px; flex-shrink: 0; display: none; }
  .progress-fill  { height: 100%; background: var(--accent); transition: width 0.2s; width: 0; }

  .tabs { display: flex; padding-top: 22px; border-bottom: 1px solid var(--border); }
  .tab {
    padding: 9px 22px; font-family: 'Space Mono', monospace; font-size: 10px;
    letter-spacing: 2px; text-transform: uppercase; cursor: pointer; color: var(--muted);
    border: 1px solid transparent; border-bottom: none;
    position: relative; top: 1px; background: transparent; transition: color 0.15s;
  }
  .tab:hover { color: var(--text); }
  .tab.on { color: var(--accent); border-color: var(--border); border-bottom-color: var(--bg); background: var(--bg); }
  .badge { display: inline-block; background: var(--accent); color: #000; font-size: 8px; padding: 1px 5px; border-radius: 8px; margin-left: 5px; font-weight: 700; vertical-align: middle; }
  .badge.red { background: var(--red); color: #fff; }

  .results { padding: 24px 0; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(310px, 1fr)); gap: 14px; }
  .empty { text-align: center; padding: 80px 20px; font-family: 'Space Mono', monospace; font-size: 11px; color: var(--muted); line-height: 2.4; }
  .empty .icon { font-size: 44px; display: block; margin-bottom: 16px; opacity: 0.2; }

  .card {
    background: var(--card); border: 1px solid var(--border); padding: 18px;
    transition: border-color 0.18s, background 0.18s; animation: fadeUp 0.3s ease both;
  }
  @keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }
  .card:hover { border-color: rgba(0,255,136,0.35); background: #161c24; }
  .card.star  { border-color: var(--accent2); background: rgba(0,196,255,0.04); }
  .card.dead  { border-color: rgba(255,68,102,0.3); opacity: 0.42; }

  .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
  .ticker { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
  .co-name { font-family: 'Space Mono', monospace; font-size: 9px; color: var(--muted); margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 195px; }
  .score-chip {
    background: linear-gradient(135deg, var(--accent) 0%, #00c4ff 100%);
    color: #000; padding: 3px 9px; font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700;
    clip-path: polygon(0 0, calc(100% - 5px) 0, 100% 5px, 100% 100%, 5px 100%, 0 calc(100% - 5px)); flex-shrink: 0;
  }

  .spark { height: 56px; margin: 10px 0; }
  .spark svg { width: 100%; height: 100%; overflow: visible; }

  .stats { display: grid; grid-template-columns: repeat(3,1fr); gap: 6px; margin-bottom: 14px; }
  .stat { background: var(--panel); padding: 7px 9px; }
  .stat-lbl { font-family: 'Space Mono', monospace; font-size: 8px; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 2px; }
  .stat-val { font-size: 13px; font-weight: 700; }
  .g { color: var(--accent); } .r { color: var(--red); }

  .card-acts { display: flex; gap: 7px; }
  .act {
    flex: 1; padding: 7px 6px; font-family: 'Space Mono', monospace; font-size: 9px;
    letter-spacing: 1px; text-transform: uppercase; border: 1px solid var(--border);
    background: transparent; cursor: pointer; transition: all 0.14s; color: var(--muted);
  }
  .act.research { color: var(--accent2); border-color: rgba(0,196,255,0.3); }
  .act.research:hover, .act.research.on { background: rgba(0,196,255,0.08); border-color: var(--accent2); }
  .act.trash { color: var(--red); border-color: rgba(255,68,102,0.3); }
  .act.trash:hover, .act.trash.on { background: rgba(255,68,102,0.08); border-color: var(--red); }

  .rpanel { display: none; margin-top: 28px; border: 1px solid var(--accent2); padding: 18px 22px; }
  .rpanel.on { display: block; }
  .rpanel-ttl { font-family: 'Space Mono', monospace; font-size: 9px; letter-spacing: 3px; color: var(--accent2); text-transform: uppercase; margin-bottom: 14px; }
  .pills { display: flex; flex-wrap: wrap; gap: 8px; }
  .pill {
    background: rgba(0,196,255,0.08); border: 1px solid var(--accent2);
    color: var(--accent2); padding: 5px 12px;
    font-family: 'Space Mono', monospace; font-size: 11px; font-weight: 700;
    display: flex; align-items: center; gap: 8px;
  }
  .pill button { background: none; border: none; color: inherit; cursor: pointer; font-size: 15px; opacity: 0.55; line-height: 1; }
  .pill button:hover { opacity: 1; }

  /* â”€â”€ Data source info panel â”€â”€ */
  .source-panel {
    display: none; margin-top: 28px;
    border: 1px solid var(--border); background: var(--panel);
  }
  .source-panel.on { display: block; }

  .source-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 12px 18px; border-bottom: 1px solid var(--border);
    cursor: pointer; user-select: none;
  }
  .source-header:hover { background: rgba(255,255,255,0.02); }

  .source-title {
    font-family: 'Space Mono', monospace; font-size: 9px;
    letter-spacing: 3px; text-transform: uppercase; color: var(--muted);
  }

  .source-toggle {
    font-family: 'Space Mono', monospace; font-size: 9px;
    color: var(--muted); transition: transform 0.2s;
  }
  .source-toggle.open { transform: rotate(180deg); }

  .source-body { padding: 18px; display: none; }
  .source-body.open { display: block; }

  .source-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1px; background: var(--border); margin-bottom: 18px;
  }

  .source-stat {
    background: var(--card); padding: 14px 16px;
  }
  .source-stat-lbl {
    font-family: 'Space Mono', monospace; font-size: 8px;
    color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 5px;
  }
  .source-stat-val {
    font-size: 20px; font-weight: 800; letter-spacing: -0.5px;
  }
  .source-stat-sub {
    font-family: 'Space Mono', monospace; font-size: 9px;
    color: var(--muted); margin-top: 3px;
  }

  .source-breakdown {
    display: flex; gap: 0; border: 1px solid var(--border); overflow: hidden; margin-bottom: 16px;
  }
  .source-seg {
    height: 6px; transition: width 0.6s ease;
  }

  .source-legend {
    display: flex; gap: 20px; flex-wrap: wrap;
    font-family: 'Space Mono', monospace; font-size: 9px; color: var(--muted);
  }
  .source-legend-item { display: flex; align-items: center; gap: 6px; }
  .source-legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

  .source-routes {
    margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;
    display: flex; flex-direction: column; gap: 8px;
  }
  .route-row {
    display: flex; align-items: center; gap: 10px;
    font-family: 'Space Mono', monospace; font-size: 9px;
  }
  .route-icon { font-size: 13px; width: 20px; text-align: center; flex-shrink: 0; }
  .route-label { color: var(--muted); flex: 1; }
  .route-count {
    padding: 2px 8px; font-size: 9px; font-weight: 700;
    font-family: 'Space Mono', monospace;
  }
  .route-count.live-direct { background: rgba(0,255,136,0.12); color: var(--accent); border: 1px solid rgba(0,255,136,0.3); }
  .route-count.live-proxy  { background: rgba(0,196,255,0.12); color: var(--accent2); border: 1px solid rgba(0,196,255,0.3); }
  .route-count.simulated   { background: rgba(255,204,0,0.12); color: var(--yellow); border: 1px solid rgba(255,204,0,0.3); }
  .route-count.failed      { background: rgba(255,68,102,0.12); color: var(--red); border: 1px solid rgba(255,68,102,0.3); }

  .route-bar-track { width: 80px; height: 3px; background: var(--border); flex-shrink: 0; }
  .route-bar-fill  { height: 100%; transition: width 0.5s ease; }

  .footnote {
    margin-top: 28px; padding: 14px 18px; border-left: 2px solid var(--accent);
    background: rgba(0,255,136,0.02); font-family: 'Space Mono', monospace;
    font-size: 9px; color: var(--muted); line-height: 1.9;
  }
  .footnote strong { color: var(--accent); }
  .footnote a { color: var(--accent2); text-decoration: none; }
</style>
</head>
<body>
<div class="wrap">

  <header>
    <div class="header-inner">
      <div>
        <div class="logo-tag">// Momentum Scanner</div>
        <h1>Trend <em>Hunter</em></h1>
        <p class="subtitle">4-MONTH BREAKOUT PATTERN Â· LIVE YAHOO FINANCE DATA</p>
      </div>
      <div class="hdr-btns">
        <span class="data-mode" id="modeTag">â— INITIALIZING</span>
        <button class="btn-primary" id="mainBtn" onclick="runScan()">â–¶ Scan Market</button>
      </div>
    </div>
  </header>

  <div class="filters">
    <div class="filter-chip">
      <label>Min Gain</label>
      <input type="number" id="fMinGain" value="60" min="10" max="500" style="width:48px">
      <span style="font-family:monospace;font-size:10px;color:var(--muted)">%</span>
    </div>
    <div class="filter-chip">
      <label>Price $</label>
      <input type="number" id="fMinPrice" value="2" min="0.5" step="0.5" style="width:40px">
      <span style="color:var(--muted);font-size:10px">â€“</span>
      <input type="number" id="fMaxPrice" value="150" min="5" style="width:50px">
    </div>
    <div class="filter-chip">
      <label>Trend Quality</label>
      <select id="fSmooth">
        <option value="0.65">Strict</option>
        <option value="0.45" selected>Moderate</option>
        <option value="0.25">Loose</option>
      </select>
    </div>
    <div class="filter-chip">
      <label>Pullback</label>
      <select id="fPullback">
        <option value="any">Any</option>
        <option value="ideal" selected>5â€“25% (ideal)</option>
        <option value="tight">Under 10%</option>
      </select>
    </div>
  </div>

  <div class="statusbar">
    <div class="dot" id="dot"></div>
    <span id="statusMsg">Starting upâ€¦</span>
    <div class="progress-track" id="track"><div class="progress-fill" id="fill"></div></div>
  </div>

  <div class="tabs">
    <div class="tab on" id="tab-all"      onclick="setTab('all')">All Results <span class="badge" id="b-all">0</span></div>
    <div class="tab"    id="tab-research" onclick="setTab('research')">â˜… Research <span class="badge" id="b-research">0</span></div>
    <div class="tab"    id="tab-trash"    onclick="setTab('trash')">âœ• Discard <span class="badge red" id="b-trash">0</span></div>
  </div>

  <div class="results">
    <div id="grid"><div class="empty"><span class="icon">â—ˆ</span>Initializing scannerâ€¦</div></div>
    <div class="rpanel" id="rpanel">
      <div class="rpanel-ttl">â˜… Research Pile</div>
      <div class="pills" id="pillbox"></div>
    </div>
  </div>

  <!-- Data Source Info Panel -->
  <div class="source-panel" id="sourcePanel">
    <div class="source-header" onclick="toggleSourceBody()">
      <span class="source-title">â¬¡ Data Source Details</span>
      <span class="source-toggle" id="sourceToggle">â–¼</span>
    </div>
    <div class="source-body" id="sourceBody">
      <div class="source-grid">
        <div class="source-stat">
          <div class="source-stat-lbl">Tickers Scanned</div>
          <div class="source-stat-val" id="si-total">â€”</div>
          <div class="source-stat-sub">NYSE + NASDAQ universe</div>
        </div>
        <div class="source-stat">
          <div class="source-stat-lbl">Live Prices Fetched</div>
          <div class="source-stat-val g" id="si-live">â€”</div>
          <div class="source-stat-sub" id="si-live-sub">â€”</div>
        </div>
        <div class="source-stat">
          <div class="source-stat-lbl">Simulated Fallback</div>
          <div class="source-stat-val" style="color:var(--yellow)" id="si-sim">â€”</div>
          <div class="source-stat-sub" id="si-sim-sub">â€”</div>
        </div>
        <div class="source-stat">
          <div class="source-stat-lbl">Failed / Skipped</div>
          <div class="source-stat-val r" id="si-failed">â€”</div>
          <div class="source-stat-sub">No data returned</div>
        </div>
        <div class="source-stat">
          <div class="source-stat-lbl">Data As Of</div>
          <div class="source-stat-val" style="font-size:14px" id="si-asof">â€”</div>
          <div class="source-stat-sub">Last market close</div>
        </div>
        <div class="source-stat">
          <div class="source-stat-lbl">Matches Found</div>
          <div class="source-stat-val g" id="si-matches">â€”</div>
          <div class="source-stat-sub">Passed all filters</div>
        </div>
      </div>

      <div class="source-breakdown" id="sourceBar">
        <div class="source-seg" id="seg-direct" style="background:var(--accent);width:0%"></div>
        <div class="source-seg" id="seg-proxy"  style="background:var(--accent2);width:0%"></div>
        <div class="source-seg" id="seg-sim"    style="background:var(--yellow);width:0%"></div>
        <div class="source-seg" id="seg-failed" style="background:#333;width:0%"></div>
      </div>

      <div class="source-legend">
        <div class="source-legend-item"><div class="source-legend-dot" style="background:var(--accent)"></div>Yahoo Finance (direct)</div>
        <div class="source-legend-item"><div class="source-legend-dot" style="background:var(--accent2)"></div>Yahoo Finance (via proxy)</div>
        <div class="source-legend-item"><div class="source-legend-dot" style="background:var(--yellow)"></div>Simulated data</div>
        <div class="source-legend-item"><div class="source-legend-dot" style="background:#444"></div>Failed / no data</div>
      </div>

      <div class="source-routes">
        <div class="route-row">
          <span class="route-icon">ğŸŸ¢</span>
          <span class="route-label">Yahoo Finance â€” direct <span style="opacity:0.5">(query1.finance.yahoo.com)</span></span>
          <div class="route-bar-track"><div class="route-bar-fill" id="bar-direct" style="background:var(--accent);width:0%"></div></div>
          <span class="route-count live-direct" id="rc-direct">0</span>
        </div>
        <div class="route-row">
          <span class="route-icon">ğŸ”µ</span>
          <span class="route-label">Yahoo Finance â€” via corsproxy.io <span style="opacity:0.5">(CORS bypass)</span></span>
          <div class="route-bar-track"><div class="route-bar-fill" id="bar-proxy" style="background:var(--accent2);width:0%"></div></div>
          <span class="route-count live-proxy" id="rc-proxy">0</span>
        </div>
        <div class="route-row">
          <span class="route-icon">ğŸŸ¡</span>
          <span class="route-label">Simulated â€” pattern-generated fallback <span style="opacity:0.5">(no network)</span></span>
          <div class="route-bar-track"><div class="route-bar-fill" id="bar-sim" style="background:var(--yellow);width:0%"></div></div>
          <span class="route-count simulated" id="rc-sim">0</span>
        </div>
        <div class="route-row">
          <span class="route-icon">ğŸ”´</span>
          <span class="route-label">Failed â€” ticker returned no usable data</span>
          <div class="route-bar-track"><div class="route-bar-fill" id="bar-failed" style="background:var(--red);width:0%"></div></div>
          <span class="route-count failed" id="rc-failed">0</span>
        </div>
      </div>
    </div>
  </div>

  <div class="footnote">
    <strong>HOW IT WORKS:</strong> Scans ~200 NYSE/NASDAQ tickers. Scores each on: total 4-month gain from trough â†’ peak, trend smoothness (RÂ² of linear regression), healthy 5â€“25% pullback from peak (consolidation setup), and volume expansion. Higher score = closer match to a steady multi-month breakout.<br><br>
    <strong>DISCLAIMER:</strong> Not financial advice. Technical screening only. Always do your own research.
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allStocks   = [];
let activeTab   = 'all';
let researchSet = new Set();
let trashSet    = new Set();
let usingLive   = false;

// Per-scan data source tracking
let routeCounts = { direct: 0, proxy: 0, sim: 0, failed: 0 };
let scanAsOf    = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TICKER UNIVERSE  (~200 liquid NYSE/NASDAQ names)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TICKERS = [
  // Large/mega cap momentum
  'NVDA','AMD','SMCI','MELI','CELH','AXON','DKNG','DUOL','COIN','ASTS',
  // Mid cap growth
  'HIMS','IONQ','RXRX','ACHR','LUNR','RKLB','JOBY','CIFR','MARA','CLSK',
  'IREN','RIOT','HUT','WULF','CORZ','BTBT','BITF','SDIG','NKLA','BLNK',
  // Tech / SaaS
  'GTLB','DOMO','DOCN','BAND','CARG','ALKT','RELY','FRSH','FSLY','BASE',
  'BIGC','COUR','ASAN','S','SMAR','JAMF','SUMO','AMPL','MTTR','PAYO',
  // Semiconductors
  'CRDO','ACMR','AEHR','COHU','FORM','DIOD','NVTS','CRUS','SITM','POWI',
  'AMBA','ALGM','AIOT','OPAD','MLGO','LSCC','RMBS','KLIC','ONTO','UCTT',
  // Healthcare / Biotech
  'HALO','CDNA','CLDX','ADMA','DVAX','RXDX','ARDX','ARQT','CRNX','FOLD',
  'ROIV','PMVP','IMVT','AVDX','BHVN','CPRX','AMPH','ANIP','CERT','AGIO',
  // Financials / Fintech
  'FUTU','DLO','GCMG','ATLC','FBRT','FCFS','COOP','BRKL','CCNE','CHCO',
  'CVBF','CWBC','FFBC','FISI','BCAL','BSIG','DLHC','GGAL','PAYO','STEP',
  // Energy
  'TTI','ARLP','CORR','ALTG','CBUS','DXP','DXPE','ARCB','APOG','ATRO',
  // Consumer / Retail
  'BOOT','BRBR','DRVN','CARG','CHDN','CBRL','DENN','COOK','CONN','CWH',
  // Industrial / Misc
  'AVNT','FORM','CPRT','CERT','CNMD','GKOS','HOLX','ATEC','CEVA','FCNCA',
  // Small cap speculative
  'AGYS','ALRM','AORT','AZTA','AZEK','BCOV','BFLY','BFAM','BLBD','BAND',
  'CALX','CARE','CASS','CCCS','CLBT','CLFD','CMBT','CMCO','CNXC','DCBO',
  'DCOM','DGII','DLHC','DOCS','DORM','DYAI','EGHT','ENVX','EPAM','EVI',
  'EXAS','EXPI','EXTR','FATE','FLNC','FLYW','GATO','GETY','GLBE','GLDD',
  'GLNG','GPRO','GRND','GSAT','GTLS','HAYW','HLLY','HOLX','CNMD','ADMA',
];

// Deduplicate
const TICKER_LIST = [...new Set(TICKERS)];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LIVE DATA â€” Yahoo Finance via CORS proxy
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PROXY = 'https://corsproxy.io/?';

async function fetchYahoo(ticker) {
  const end   = Math.floor(Date.now() / 1000);
  const start = end - 150 * 86400;
  const url   = `https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&period1=${start}&period2=${end}`;

  const attempts = [
    { u: url,                                   route: 'direct' },
    { u: PROXY + encodeURIComponent(url),       route: 'proxy'  },
  ];

  for (const { u, route } of attempts) {
    try {
      const res = await fetch(u, { signal: AbortSignal.timeout(8000) });
      if (!res.ok) continue;
      const json = await res.json();
      const result = json?.chart?.result?.[0];
      if (!result) continue;

      const rawCloses  = result.indicators?.quote?.[0]?.close  ?? [];
      const rawVolumes = result.indicators?.quote?.[0]?.volume ?? [];
      const meta       = result.meta ?? {};

      const valid = rawCloses
        .map((c, i) => ({ c, v: rawVolumes[i] || 0 }))
        .filter(x => x.c != null && isFinite(x.c) && x.c > 0);

      if (valid.length < 55) continue;

      // Track which route worked and data timestamp
      routeCounts[route]++;
      if (!scanAsOf && meta.regularMarketTime) {
        scanAsOf = new Date(meta.regularMarketTime * 1000);
      }

      return {
        ticker,
        name:         meta.shortName || meta.longName || ticker,
        currentPrice: meta.regularMarketPrice || valid[valid.length - 1].c,
        prices:  valid.map(x => x.c),
        volumes: valid.map(x => x.v),
        route,
        live: true,
      };
    } catch (_) { /* try next */ }
  }
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIMULATED DATA â€” fallback if Yahoo blocked
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SIM_DB = {
  // ticker -> [startPrice, peakMult, noise, daysToRun, dip]
  'NVDA': [50,  2.8, 0.04, 72, 0.12], 'AMD':  [18,  2.4, 0.05, 68, 0.14],
  'SMCI': [30,  3.5, 0.07, 65, 0.18], 'MELI': [160, 2.0, 0.04, 74, 0.09],
  'AXON': [62,  2.1, 0.04, 73, 0.11], 'DKNG': [28,  1.9, 0.05, 66, 0.08],
  'DUOL': [88,  2.4, 0.05, 69, 0.09], 'COIN': [40,  2.7, 0.07, 62, 0.17],
  'HIMS': [7.5, 2.8, 0.05, 68, 0.13], 'IONQ': [9.2, 2.9, 0.06, 67, 0.15],
  'MARA': [8.3, 3.4, 0.09, 60, 0.20], 'CLSK': [6.7, 3.2, 0.08, 62, 0.18],
  'IREN': [4.1, 3.5, 0.08, 64, 0.16], 'CIFR': [2.9, 3.8, 0.09, 58, 0.21],
  'CRDO': [12.5,3.1, 0.06, 68, 0.17], 'AEHR': [11.6,2.4, 0.08, 63, 0.18],
  'BOOT': [37,  2.3, 0.04, 70, 0.11], 'DOCN': [22,  2.5, 0.05, 69, 0.13],
  'ADMA': [4.3, 3.0, 0.08, 61, 0.20], 'CDNA': [9.6, 2.9, 0.06, 67, 0.15],
  'TTI':  [3.2, 3.6, 0.04, 72, 0.10], 'GTLB': [38,  2.2, 0.05, 71, 0.10],
  'BRBR': [24,  2.1, 0.04, 70, 0.09], 'FUTU': [44,  2.3, 0.07, 63, 0.16],
  'RXRX': [5.3, 2.4, 0.08, 60, 0.22], 'ACHR': [4.2, 3.0, 0.10, 58, 0.19],
  'LUNR': [5.1, 2.8, 0.10, 56, 0.23], 'NVTS': [3.4, 2.5, 0.08, 61, 0.20],
  'CLDX': [11.8,2.6, 0.07, 65, 0.19], 'DVAX': [11.2,2.3, 0.07, 63, 0.17],
  'CPRT': [42,  1.7, 0.03, 75, 0.07], 'HOLX': [62,  1.7, 0.03, 73, 0.07],
  'CRUS': [52,  1.8, 0.04, 73, 0.08], 'AVNT': [34,  1.9, 0.04, 72, 0.09],
  'DOMO': [7.8, 2.8, 0.07, 63, 0.18], 'BAND': [11,  2.6, 0.06, 66, 0.14],
  'CARG': [18,  2.1, 0.05, 71, 0.10], 'ALKT': [14,  2.2, 0.06, 67, 0.13],
};

function seededRng(seed) {
  let s = (seed % 2147483647 + 2147483647) % 2147483647;
  return () => { s = (s * 16807) % 2147483647; return (s - 1) / 2147483646; };
}

function simulatePrices(ticker) {
  const params = SIM_DB[ticker];
  const [startP, peakMult, noise, daysRun, dip] = params
    || [10 + (ticker.charCodeAt(0) % 30), 2.0 + Math.random(), 0.06, 65, 0.14];

  const rand      = seededRng(ticker.split('').reduce((a, c) => a + c.charCodeAt(0), 0));
  const totalDays = 88;
  const peakDay   = Math.min(daysRun, totalDays - 8);
  const peakPrice = startP * peakMult;
  const prices    = [];

  // Setup (slight drift / flat)
  let price = startP * (1 + (rand() - 0.52) * 0.05);
  for (let i = 0; i < 10; i++) {
    price *= 1 - rand() * 0.005;
    prices.push(Math.max(0.1, price * (1 + (rand() - 0.5) * noise)));
  }

  // Uptrend
  for (let i = 0; i < peakDay; i++) {
    const t      = i / peakDay;
    const eased  = t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t;
    const target = startP + (peakPrice - startP) * eased;
    price        = price * 0.3 + target * 0.7;
    prices.push(Math.max(0.1, price * (1 + (rand() - 0.47) * noise)));
  }

  // Pullback / consolidation
  const dipTarget = peakPrice * (1 - dip);
  const remain    = totalDays - prices.length;
  for (let i = 0; i < remain; i++) {
    const t      = i / Math.max(1, remain - 1);
    const target = peakPrice - (peakPrice - dipTarget) * Math.sqrt(t);
    price        = price * 0.35 + target * 0.65;
    prices.push(Math.max(0.1, price * (1 + (rand() - 0.52) * noise * 0.7)));
  }

  const volumes = prices.map((_, i) =>
    Math.floor((400000 + rand() * 900000) * (1 + (i / prices.length) * 1.2))
  );

  return {
    ticker,
    name: ticker,
    currentPrice: prices[prices.length - 1],
    prices,
    volumes,
    route: 'sim',
    live: false,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCORING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcR2(ys) {
  const n = ys.length;
  if (n < 3) return 0;
  const xm = (n - 1) / 2;
  const ym = ys.reduce((a, b) => a + b, 0) / n;
  let sxy = 0, sxx = 0, tot = 0, res = 0;
  for (let i = 0; i < n; i++) {
    sxy += (i - xm) * (ys[i] - ym);
    sxx += (i - xm) ** 2;
    tot += (ys[i] - ym) ** 2;
  }
  if (!sxx || !tot) return 0;
  const m = sxy / sxx, b = ym - m * xm;
  for (let i = 0; i < n; i++) res += (ys[i] - (m * i + b)) ** 2;
  return Math.max(0, 1 - res / tot);
}

function scoreStock(data, opts) {
  const { minGain, minPrice, maxPrice, smoothness, pullbackMode } = opts;
  const { prices, volumes, currentPrice } = data;

  if (currentPrice < minPrice || currentPrice > maxPrice) return null;

  const n        = prices.length;
  const setupEnd = Math.max(5, Math.floor(n * 0.28));
  const troughP  = Math.min(...prices.slice(0, setupEnd));
  const troughI  = prices.slice(0, setupEnd).indexOf(troughP);
  const after    = prices.slice(troughI);
  const peakP    = Math.max(...after);
  const peakI    = after.indexOf(peakP);
  const gain     = (peakP - troughP) / troughP;

  if (gain < minGain) return null;

  const daysSincePeak = after.length - 1 - peakI;
  if (daysSincePeak > 42) return null;   // peak must be recent

  const uptrend = after.slice(0, peakI + 1);
  if (uptrend.length < 12) return null;
  const r2 = calcR2(uptrend);
  if (r2 < smoothness) return null;

  const pullback = (peakP - currentPrice) / peakP;
  let pbScore = 0;
  if (pullbackMode === 'ideal') {
    if (pullback >= 0.05 && pullback <= 0.25)      pbScore = 1.0;
    else if (pullback < 0.05)                      pbScore = 0.55;
    else                                           return null;
  } else if (pullbackMode === 'tight') {
    if (pullback < 0.10)  pbScore = 1.0;
    else                  pbScore = 0.4;
  } else {
    pbScore = pullback > 0.40 ? 0.2 : pullback > 0.25 ? 0.6 : 1.0;
  }

  const half   = Math.floor(volumes.length / 2);
  const avgV1  = volumes.slice(0, half).reduce((a, b) => a + b, 0) / (half || 1);
  const avgV2  = volumes.slice(half).reduce((a, b) => a + b, 0) / ((volumes.length - half) || 1);
  const volScore = avgV2 > avgV1 * 1.05 ? 1.0 : avgV2 > avgV1 * 0.88 ? 0.65 : 0.35;

  return {
    score:       Math.round(gain * 38 + r2 * 28 + pbScore * 20 + volScore * 14),
    totalGain:   gain,
    r2,
    pullback,
    peakPrice:   peakP,
    troughPrice: troughP,
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCAN ORCHESTRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runScan() {
  const btn = document.getElementById('mainBtn');
  btn.disabled = true;
  btn.textContent = 'â—Œ Scanningâ€¦';
  allStocks = [];
  researchSet.clear();
  trashSet.clear();
  routeCounts = { direct: 0, proxy: 0, sim: 0, failed: 0 };
  scanAsOf    = null;
  updateBadges();

  setStatus('run', 'Testing connection to Yahoo Financeâ€¦');
  document.getElementById('track').style.display = 'block';
  document.getElementById('fill').style.width = '0%';
  document.getElementById('grid').innerHTML = '';

  const opts = {
    minGain:      parseFloat(document.getElementById('fMinGain').value)  / 100,
    minPrice:     parseFloat(document.getElementById('fMinPrice').value),
    maxPrice:     parseFloat(document.getElementById('fMaxPrice').value),
    smoothness:   parseFloat(document.getElementById('fSmooth').value),
    pullbackMode: document.getElementById('fPullback').value,
  };

  // â”€â”€ Test if Yahoo Finance is reachable (direct or via proxy) â”€â”€
  usingLive = await testYahooConnection();
  setModeTag(usingLive);

  const results   = [];
  const BATCH     = usingLive ? 4 : 8;   // smaller batches for live to be polite
  const DELAY     = usingLive ? 350 : 15; // ms between batches

  for (let i = 0; i < TICKER_LIST.length; i += BATCH) {
    const batch = TICKER_LIST.slice(i, i + BATCH);
    const pct   = Math.round((i / TICKER_LIST.length) * 100);
    document.getElementById('fill').style.width = pct + '%';
    setStatus('run',
      `${usingLive ? 'ğŸ“¡ Live' : 'â—ˆ Sim'} Â· Scanning ${i + 1}â€“${Math.min(i + BATCH, TICKER_LIST.length)} of ${TICKER_LIST.length} Â· ${results.length} matches`
    );

    await Promise.allSettled(batch.map(async ticker => {
      try {
        let raw;
        if (usingLive) {
          raw = await fetchYahoo(ticker);
          if (!raw) {
            // Live fetch failed â€” fall back to sim if available
            raw = simulatePrices(ticker);
            raw.route = 'sim';
            routeCounts.sim++;
          }
        } else {
          raw = simulatePrices(ticker);
          raw.route = 'sim';
          routeCounts.sim++;
        }
        const scored = scoreStock(raw, opts);
        if (scored) results.push({ ...raw, ...scored });
      } catch (_) {
        routeCounts.failed++;
      }
    }));

    if (DELAY > 50) await sleep(DELAY);
    else await tick();
  }

  results.sort((a, b) => b.score - a.score);
  allStocks = results.slice(0, 80);

  document.getElementById('fill').style.width = '100%';
  document.getElementById('track').style.display = 'none';

  const modeStr = usingLive ? 'ğŸ“¡ LIVE Yahoo Finance data' : 'â—ˆ Simulated data (Yahoo blocked)';
  setStatus('done',
    `Scan complete Â· ${allStocks.length} matches found Â· ${modeStr}`
  );

  btn.disabled = false;
  btn.textContent = 'â–¶ Re-Scan';
  updateBadges();
  updateSourcePanel();
  renderGrid();
}

async function testYahooConnection() {
  const testUrl = 'https://query1.finance.yahoo.com/v8/finance/chart/AAPL?interval=1d&range=5d';
  for (const url of [testUrl, PROXY + encodeURIComponent(testUrl)]) {
    try {
      const res = await fetch(url, { signal: AbortSignal.timeout(6000) });
      if (res.ok) {
        const j = await res.json();
        if (j?.chart?.result?.[0]?.indicators?.quote?.[0]?.close?.length > 0) return true;
      }
    } catch (_) {}
  }
  return false;
}

function setModeTag(live) {
  const el = document.getElementById('modeTag');
  el.textContent = live ? 'â— LIVE DATA' : 'â— SIMULATED';
  el.className   = 'data-mode ' + (live ? 'live' : 'sim');
}

const sleep = ms => new Promise(r => setTimeout(r, ms));
const tick  = ()  => new Promise(r => setTimeout(r, 0));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setTab(tab) {
  activeTab = tab;
  ['all','research','trash'].forEach(t =>
    document.getElementById('tab-' + t).classList.toggle('on', t === tab)
  );
  renderGrid();
}

function updateBadges() {
  document.getElementById('b-all').textContent      = allStocks.length;
  document.getElementById('b-research').textContent = researchSet.size;
  document.getElementById('b-trash').textContent    = trashSet.size;
}

function renderGrid() {
  const grid = document.getElementById('grid');
  let list   = allStocks;
  if (activeTab === 'research') list = allStocks.filter(s => researchSet.has(s.ticker));
  if (activeTab === 'trash')    list = allStocks.filter(s => trashSet.has(s.ticker));

  if (!list.length) {
    const msgs = {
      all:      allStocks.length === 0
                  ? 'Press <strong>Scan Market</strong> to begin scanning.'
                  : 'No stocks matched current filters â€” try loosening settings.',
      research: 'No stocks in research pile yet.<br>Click <strong>â˜… Research</strong> on any card.',
      trash:    'No discards yet.<br>Click <strong>âœ• Discard</strong> on any card.',
    };
    grid.innerHTML = `<div class="empty"><span class="icon">${{all:'â—ˆ',research:'â˜…',trash:'âœ•'}[activeTab]}</span>${msgs[activeTab]}</div>`;
    renderResearchPanel();
    return;
  }

  grid.innerHTML = `<div class="grid">${list.map((s, i) => cardHTML(s, i)).join('')}</div>`;
  renderResearchPanel();
}

function cardHTML(s, idx) {
  const isStar   = researchSet.has(s.ticker);
  const isDead   = trashSet.has(s.ticker);
  const gain4m   = (s.totalGain * 100).toFixed(0);
  const peakRun  = ((s.peakPrice - s.troughPrice) / s.troughPrice * 100).toFixed(0);
  const pullPct  = (s.pullback * 100).toFixed(1);
  const r2pct    = (s.r2 * 100).toFixed(0);
  const routeLabels = {
    direct: ['LIVEÂ·DIRECT', 'var(--accent)'],
    proxy:  ['LIVEÂ·PROXY',  'var(--accent2)'],
    sim:    ['SIMULATED',   'var(--yellow)'],
  };
  const [routeText, routeColor] = routeLabels[s.route] || ['UNKNOWN', 'var(--muted)'];
  const liveTag = `<span style="font-size:8px;font-family:monospace;color:${routeColor};margin-left:6px;opacity:0.75;letter-spacing:1px">${routeText}</span>`;

  return `<div class="card${isStar?' star':''}${isDead?' dead':''}" id="c-${s.ticker}" style="animation-delay:${idx*0.03}s">
    <div class="card-top">
      <div>
        <div class="ticker">${s.ticker}${liveTag}</div>
        <div class="co-name">${s.name || s.ticker}</div>
      </div>
      <div class="score-chip">${s.score}</div>
    </div>
    <div class="spark">${sparkSVG(s.prices)}</div>
    <div class="stats">
      <div class="stat"><div class="stat-lbl">4M Gain</div>  <div class="stat-val g">+${gain4m}%</div></div>
      <div class="stat"><div class="stat-lbl">Peak Run</div> <div class="stat-val g">+${peakRun}%</div></div>
      <div class="stat"><div class="stat-lbl">Pullback</div> <div class="stat-val ${parseFloat(pullPct)>20?'r':'g'}">${pullPct}%</div></div>
      <div class="stat"><div class="stat-lbl">Smoothness</div><div class="stat-val">${r2pct}%</div></div>
      <div class="stat"><div class="stat-lbl">Price</div>    <div class="stat-val">$${s.currentPrice.toFixed(2)}</div></div>
      <div class="stat"><div class="stat-lbl">Score</div>    <div class="stat-val g">${s.score}</div></div>
    </div>
    <div class="card-acts">
      <button class="act research${isStar?' on':''}" onclick="toggle('${s.ticker}','research')">${isStar?'â˜… In Research':'â˜… Research'}</button>
      <button class="act trash${isDead?' on':''}"    onclick="toggle('${s.ticker}','trash')">${isDead?'âœ• Discarded':'âœ• Discard'}</button>
    </div>
  </div>`;
}

function sparkSVG(prices) {
  const W = 280, H = 56;
  const min = Math.min(...prices), max = Math.max(...prices);
  const rng = max - min || 1;
  const pts = prices.map((p, i) => [
    ((i / (prices.length - 1)) * W).toFixed(1),
    (H - ((p - min) / rng) * (H - 6) - 3).toFixed(1)
  ]);
  const line = 'M' + pts.map(p => p.join(',')).join('L');
  const area = line + `L${W},${H}L0,${H}Z`;
  return `<svg viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
    <path d="${area}" fill="#00ff8814"/>
    <path d="${line}" fill="none" stroke="#00ff88" stroke-width="1.6" stroke-linejoin="round" stroke-linecap="round"/>
  </svg>`;
}

function toggle(ticker, action) {
  const main  = action === 'research' ? researchSet : trashSet;
  const other = action === 'research' ? trashSet    : researchSet;
  if (main.has(ticker)) main.delete(ticker);
  else { main.add(ticker); other.delete(ticker); }
  updateBadges();
  if (activeTab === 'all') {
    const stock = allStocks.find(s => s.ticker === ticker);
    const el    = document.getElementById('c-' + ticker);
    if (stock && el) el.outerHTML = cardHTML(stock, 0);
    renderResearchPanel();
  } else {
    renderGrid();
  }
}

function renderResearchPanel() {
  const panel = document.getElementById('rpanel');
  const pills = document.getElementById('pillbox');
  if (!researchSet.size) { panel.classList.remove('on'); return; }
  panel.classList.add('on');
  pills.innerHTML = [...researchSet].map(ticker => {
    const s = allStocks.find(x => x.ticker === ticker);
    const g = s ? `+${(s.totalGain * 100).toFixed(0)}%` : '';
    return `<div class="pill">${ticker} <span style="opacity:.55;font-size:9px">${g}</span><button onclick="toggle('${ticker}','research')">Ã—</button></div>`;
  }).join('');
}

function setStatus(state, msg) {
  document.getElementById('dot').className = 'dot ' + state;
  document.getElementById('statusMsg').innerHTML = msg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA SOURCE PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSourcePanel() {
  const panel = document.getElementById('sourcePanel');
  panel.classList.add('on');
  // Auto-open after first scan
  document.getElementById('sourceBody').classList.add('open');
  document.getElementById('sourceToggle').classList.add('open');

  const total = TICKER_LIST.length;
  const live  = routeCounts.direct + routeCounts.proxy;
  const sim   = routeCounts.sim;
  const fail  = routeCounts.failed;

  // Stats
  document.getElementById('si-total').textContent   = total;
  document.getElementById('si-live').textContent     = live;
  document.getElementById('si-sim').textContent      = sim;
  document.getElementById('si-failed').textContent   = fail;
  document.getElementById('si-matches').textContent  = allStocks.length;

  document.getElementById('si-live-sub').textContent =
    live > 0
      ? `${routeCounts.direct} direct Â· ${routeCounts.proxy} via proxy`
      : 'None â€” Yahoo Finance blocked';
  document.getElementById('si-sim-sub').textContent =
    sim > 0 ? 'Pattern-generated prices' : 'None needed';

  // As-of date
  const asof = scanAsOf || new Date();
  document.getElementById('si-asof').textContent =
    asof.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

  // Breakdown bar
  const pct = v => (total > 0 ? (v / total * 100).toFixed(1) : 0) + '%';
  document.getElementById('seg-direct').style.width = pct(routeCounts.direct);
  document.getElementById('seg-proxy').style.width  = pct(routeCounts.proxy);
  document.getElementById('seg-sim').style.width    = pct(sim);
  document.getElementById('seg-failed').style.width = pct(fail);

  // Route rows
  const setRoute = (id, count) => {
    document.getElementById('rc-' + id).textContent       = count;
    document.getElementById('bar-' + id).style.width      = pct(count);
  };
  setRoute('direct', routeCounts.direct);
  setRoute('proxy',  routeCounts.proxy);
  setRoute('sim',    sim);
  setRoute('failed', fail);
}

function toggleSourceBody() {
  const body    = document.getElementById('sourceBody');
  const chevron = document.getElementById('sourceToggle');
  const isOpen  = body.classList.toggle('open');
  chevron.classList.toggle('open', isOpen);
}

// â”€â”€ Kick off on load â”€â”€
window.addEventListener('load', () => setTimeout(runScan, 400));
</script>
</body>
</html>
